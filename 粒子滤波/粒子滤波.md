# 粒子滤波
## 重要性采样(Importance Sampling)复习
$$E[f(x)]=\int_x f(x) p(x)dx=\int_x f(x) \frac{p(x)}{q(x)} q(x) dx=\frac{1}{N} \sum_{i=1}^{N} f(x^i) \frac{p(x^i)}{q(x^i)}$$
重要采样的问题，如果在高纬中，$q(x)$很容易出现问题，导致采样效率很低，如何解决呢？
##  解决方案
$$\gamma(x_{1:N})$$
$$p(x)=\frac{\gamma(x)}{\int \gamma(x)dx}$$
$$z=\int \gamma(x)dx$$
先了解一个概念：我们可以看到$\gamma(x)$和$p(x)$之间相差了一个权重(归一化)，因此只是$p(x)$两者本质上是同一个分布，如果在他们上面采样，两者的结果都是一样的。   

* 重要性采样在高纬下的权重入下面的公式表示：
$$W(x^i_{1:N})=\frac{\gamma(x^i_{1:N})}{q(x^i_{1:N})}$$
现在我们可以参考Gibbs采样的方法来采样$q(x)$(但和Gibbs采样还是不一样的)，我们一个维度一个维度的去采样$q(x)$ ，

### 采样方法
1. dim1
$$\gamma(x_i)=\int_{x_{2:N}} \gamma(x_{1:N})dx_{2:N}$$
$$W(x^i_{1})=\frac{\gamma(x^i_1)}{q(x^i_1)}$$
2. dim2
$$W(x^i_{1:2})=\frac{\gamma(x^i_{1:2})}{q(x^i_{1:2})}$$
$$\gamma(x_{1:2})=\int_{x_{3:N}} \gamma(x_{1:N})dx_{3:N}$$
以上过程中$x_1$已经确定了  
3. dim(n)   
直到所有的维度都被采集完整，就可以实现一组维度的采集了，当然结果只是生成了一个样本的采集，这个和Gibbs采样不一样的地方，如果是Gibbs采样应该会产生维度对应的样本点数量，这里一组维度只是实现了一个样本的采集）
1. 公式推导实现递归
$$\begin{aligned}
    W(x_{1:N})&=\frac{\gamma (x_{1:N})}{q(x_{1:N})}  \\
              &=\frac{\gamma (x_{1:N})}{q(x_n|x_{1:N-1})q(x_{1:N-1})} \frac{\gamma (x_{1:N-1})}{\gamma(x_{1:N-1})}   \\
              &=\frac{\gamma (x_{1:N})}{q(x_n|x_{1:N-1})\gamma(x_{1:N-1})} \frac{\gamma (x_{1:N-1})}{q(x_{1:N-1})}  \\
              &=\frac{\gamma (x_{1:N})}{q(x_n|x_{1:N-1})\gamma(x_{1:N-1})} W(x_{1:N-1}) \\
              &=\frac{\gamma (x_n|x_{1:N-1})}{q(x_n|x_{1:N-1})} W(x_{1:N-1}) \\

\end{aligned}
$$
那么以上公式就形成了一个递归形式！，直到所有维度被采集完，注意一个维度被采集完成后，后面一个维度是在上面一个维度采集的结果上的。
* 以上推导公式我们称之为SIS(Sqquential Importance Sampling)(感觉有点像：Gibbs采样加重要性采样？)

* 我们重新以上面二维的的公式使用SIS再次推导一边  
### dim1
$$W(x^i_{1})=\frac{\gamma(x^i_1)}{q(x^i_1)}$$
下面我们需要第一个维度以外的所有维度作积分，计算对应的$q(x^i_1)$和$\gamma(x_1^i)$
$$\gamma(x_1^i)=\int_{x_{2:N}^i} \gamma(x^i_{1:N})dx^i_{2:N}$$
$$q(x_1^i)=\int_{x_{2:N}^i} q(x^i_{1:N})dx^i_{2:N}$$

### dim2
$$W(x^i_{1:2})=\frac{\gamma(x^i_{1:2})}{q(x^i_{1:2})}$$
下面确定递归公式：   
$$W(x^i_{1:2})=\frac{\gamma(x^i_{2}|x^i_{1})}{q(x^i_{2}|x^i_{1})}W(x^i_1)$$
然后确定$x_1$作为常数，来确定$\gamma(x^i_{2}|x^i_{1})$和$q(x^i_{2}|x^i_{1})$,需要注意的是这时候$x^i_1$已经被看作是一个确定的常数了
$$\gamma(x^i_{2}|x^i_{1})=\int_{x^i_{3:N}} \gamma(x^i_{1:N})dx^i_{3:N}$$
$$q(x^i_{2}|x^i_{1})=\int_{x^i_{3:N}} q(x^i_{1:N})dx^i_{3:N}$$
$W(x^i_1）$则前面已经被确定算出来了

### dim(n)
对所有维度按照上面的规则采集一边，一个样本点就出来了

# 粒子滤波总结1
1. 重要性采样公式，权重计算与采样
2. 权重公式递归
3. 对于每一个样本点进行一个一个维度的获取，每一个维度都在前面维度值确定的情况下采样，最后完成所有维度的采样，就完成了一个样本点并且获取了对应样本的权重
4. 注意点$x^i_1$不一定是一个一维度的数值，也可以是一个向量什么的，也可以代表一个隐状态


# 粒子滤波2
我们将之前的$x_{1:N}$中的N看作时间状态t，那么$x_{1:t}$所有时间序列隐状态的分布。
$$W(x_{1:N})           
              =\frac{\gamma (x_n|x_{1:N-1})}{q(x_n|x_{1:N-1})} W(x_{1:N-1})$$
$$W(x_{1:T})           
              =\frac{\gamma (x_t|x_{1:T-1})}{q(x_t|x_{1:T-1})} W(x_{1:T-1})$$